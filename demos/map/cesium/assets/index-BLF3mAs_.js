import{o as v,a as L,n as P,c as b,b as E,d as O,e as z}from"./index-BN35puBo.js";const u=window.Cesium;if(!u)throw new Error("Cesium is not available on the window object. Please make sure you have included the CesiumJS script in your index.html.");function N(){return{addWave:(n,i,e,r={})=>{const m=new u.GeometryInstance({geometry:new u.EllipseGeometry({center:u.Cartesian3.fromDegrees(i,e,0),semiMinorAxis:500,semiMajorAxis:500})}),C=new u.MaterialAppearance({material:new u.Material({fabric:{uniforms:{color:u.Color.fromCssColorString("#ffffff"),speed:.2},source:`
                        czm_material czm_getMaterial(czm_materialInput materialInput) { 
                            czm_material material = czm_getDefaultMaterial(materialInput);
                            material.diffuse = 1.5 * color.rgb; 
                            vec2 st = materialInput.st; 
                            float dis = distance(st, vec2(0.5, 0.5)); 
                            
                            // 重复三次，每次的时间偏移一点，实现三道扩散
                            float per1 = fract(czm_frameNumber * 0.032 * speed); 
                            float per2 = fract((czm_frameNumber * 0.032 * speed) - 0.3); 
                            float per3 = fract((czm_frameNumber * 0.032 * speed) - 0.6); 
                            
                            float pass1 = step(per1 * 0.3, dis) == 0.0? color.a * dis / per1: 0.0;
                            float pass2 = step(per2 * 0.3, dis) == 0.0? color.a * dis / per2: 0.0;
                            float pass3 = step(per3 * 0.3, dis) == 0.0? color.a * dis / per3: 0.0;
                            
                            // 实现每道扩散渐变消失的效果
                            pass1 = pass1 * (1.0 - per1) * 2.0;
                            pass2 = pass2 * (1.0 - per2) * 2.0;
                            pass3 = pass3 * (1.0 - per3) * 2.0;
                            
                            // --- 关键修改：将三层波纹的 alpha 值相加 ---
                            material.alpha = pass1 + pass2 + pass3; 
                            
                            return material; 
                        }
                    `}})});return n.scene.primitives.add(new u.Primitive({geometryInstances:m,appearance:C}))}}}const W=["id"],R={__name:"CesiumMap",props:["cId","loadTileset"],emits:["loaded"],setup(a,{emit:n}){const{addWave:i}=N();let e=null;const r=a;function m(){e.shadows=!1}const C=async()=>{Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OWE5YzQ2ZS05NDYzLTQ3NTEtYTZhOC0yNDhmMmIyY2I5ZTAiLCJpZCI6MTA0MTAyLCJpYXQiOjE2ODU2MTMxOTB9.JxmgXnf8_-V1eM9we2W8VfiP37vyGMJJDSWF4Br6hKU",e=new Cesium.Viewer(r.cId,{targetFrameRate:60,animation:!0,baseLayerPicker:!1,fullscreenButton:!1,vrButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,timeline:!0,navigationHelpButton:!1,shouldAnimate:!1,sceneMode:3,imageryProvider:!1});const t=await Cesium.Cesium3DTileset.fromUrl("/demos/map/cesium/Tileset/tileset.json"),s=t.boundingSphere.center,f=-425.1,c=Cesium.Cartographic.fromCartesian(s),y=Cesium.Cartesian3.fromRadians(c.longitude,c.latitude,0),I=Cesium.Cartesian3.fromRadians(c.longitude,c.latitude,f),_=Cesium.Cartesian3.subtract(I,y,new Cesium.Cartesian3);t.modelMatrix=Cesium.Matrix4.fromTranslation(_);const M=new Cesium.CustomShader({lightingModel:Cesium.LightingModel.UNLIT,fragmentShaderText:`
        void fragmentMain(FragmentInput fsInput, inout czm_modelMaterial material) {
            material.diffuse = material.diffuse * 2.2;
        }
      `});t.customShader=M,e.scene.primitives.add(t),e.scene.debugShowFramesPerSecond=!0,e.scene.globe.baseColor=Cesium.Color.fromCssColorString("#112e4a"),e.scene.postProcessStages.fxaa.enabled=!0,e.scene.camera.flyTo({duration:.5,destination:new Cesium.Cartesian3.fromDegrees(86.07081147858074,44.300018882217046,120),orientation:{heading:Cesium.Math.toRadians(90),pitch:Cesium.Math.toRadians(-36),roll:0}}),h(),m(),p(),g(),i(e,86.0725757109461,44.30009549291109),l("loaded",e)};function h(){e.scene.light=new Cesium.SunLight({intensity:7})}let d=null;function g(){d=setInterval(()=>{const t=e.camera.positionCartographic;if(t){const s=Cesium.Math.toDegrees(t.longitude),f=Cesium.Math.toDegrees(t.latitude),c=t.height;console.log(`中心点坐标：经纬度 ${s},${f}, 高度 ${c}`)}},1e3)}function p(){e.cesiumWidget.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),e.scene.screenSpaceCameraController.tiltEventTypes=[Cesium.CameraEventType.RIGHT_DRAG],e.scene.screenSpaceCameraController.zoomEventTypes=[Cesium.CameraEventType.WHEEL],e.scene.screenSpaceCameraController.rotateEventTypes=[Cesium.CameraEventType.LEFT_DRAG]}const l=n;return v(()=>{d&&clearInterval(d),e==null||e.destroy()}),L(()=>{P(()=>{C()})}),(t,s)=>(E(),b("div",{class:"track3D-container",id:r.cId},null,8,W))}};function B(){let a=null,n=null;const i=new Map,e={id:"id",longitude:"longitude",latitude:"latitude",type:"originalType",speed:"speed",courseAngle:"courseAngle"},r={default:{name:"默認車輛",glb:"/glb/xiaokeche.glb",scale:1.5}},m=1e4,C=(d,g)=>{a=d,n=new WebSocket(g),n.onopen=()=>{a.clock.shouldAnimate=!1,console.log("WebSocket 連接成功!")},n.onmessage=p=>{try{const l=JSON.parse(p.data);l.e1FrameParticipant&&h(l.e1FrameParticipant,l.timeStamp)}catch(l){console.error("處理WebSocket消息失敗:",l)}},n.onclose=()=>{console.log("WebSocket 連接已斷開。")},n.onerror=p=>{console.error("WebSocket 發生錯誤:",p)}};function h(d,g){if(!a)return;const p=Cesium.JulianDate.fromIso8601(new Date(g).toISOString()),l=new Set(d.map(t=>t[e.id]));i.forEach((t,s)=>{l.has(s)||(a.entities.remove(t),i.delete(s))}),d.forEach(t=>{const s=t[e.id],f=t[e.longitude],c=t[e.latitude],y=t[e.type],I=t[e.courseAngle],_=t[e.speed];if(s===void 0||f===void 0||c===void 0)return;const M=Cesium.Cartesian3.fromDegrees(f,c,0);let o=i.get(s);const A=r[y]||r.default;if(!o){const w=new Cesium.SampledPositionProperty;w.setInterpolationOptions({interpolationDegree:1,interpolationAlgorithm:Cesium.LinearApproximation});const T=document.createElement("canvas"),D=T.getContext("2d");T.width=200,T.height=80,o=a.entities.add({id:s,position:w,orientation:new Cesium.CallbackProperty(k=>{const x=Cesium.Math.toRadians(90-(o.courseAngle||0));return Cesium.Transforms.headingPitchRollQuaternion(o.position.getValue(k),new Cesium.HeadingPitchRoll(x,0,0))},!1),model:{uri:A.glb,scale:10,minimumPixelSize:32,distanceDisplayCondition:new Cesium.DistanceDisplayCondition(0,m)},point:{pixelSize:8,color:Cesium.Color.AQUA,distanceDisplayCondition:new Cesium.DistanceDisplayCondition(m,Number.POSITIVE_INFINITY)}}),o.labelContext=D,i.set(s,o)}const S=o.vehicleData;!S||Math.abs(S.speed-_)>1,!S||S.type,o.vehicleData=t,o.courseAngle=I,o.position.addSample(p,M)})}return v(()=>{n&&n.close(),a&&!a.isDestroyed()&&(a.entities.removeAll(),a.destroy()),i.clear()}),{playSocket:C}}const J={class:"homeC",style:{width:"100%",height:"100%"}},F="ws://localhost:8585",U={__name:"index",setup(a){const{playSocket:n}=B(),i=e=>{n(e,F)};return(e,r)=>{const m=R;return E(),b("div",J,[r[0]||(r[0]=O("div",{class:"mask"},null,-1)),z(m,{onLoaded:i,cId:"id111"})])}}};export{U as default};
