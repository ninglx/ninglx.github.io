<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium Flow Line with Arrows</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
<div id="cesiumContainer"></div>
<script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OWE5YzQ2ZS05NDYzLTQ3NTEtYTZhOC0yNDhmMmIyY2I5ZTAiLCJpZCI6MTA0MTAyLCJpYXQiOjE2ODU2MTMxOTB9.JxmgXnf8_-V1eM9we2W8VfiP37vyGMJJDSWF4Br6hKU';
    // 初始化Cesium Viewer
    var viewer = new Cesium.Viewer('cesiumContainer', {
        // terrainProvider: Cesium.createWorldTerrain()
    });

    // 确保删除可能存在的旧实体
    viewer.entities.removeAll();

    // 重新创建更明显的线条
    var positions = Cesium.Cartesian3.fromDegreesArray([
        -74.0, 40.7,
        -100.0, 40.7,  // 中间点
        -118.2, 34.1
    ]);

    // 更明显的白色底线
    var baseLine = viewer.entities.add({
        polyline: {
            positions: positions,
            width: 10,
            material: new Cesium.PolylineGlowMaterialProperty({
                glowPower: 0.3,
                color: Cesium.Color.WHITE
            }),
            zIndex: 0
        }
    });

    // 改进的流动箭头材质
    var flowingArrowMaterial = new Cesium.Material({
        fabric: {
            type: 'FlowArrow',
            uniforms: {
                color: Cesium.Color.RED.withAlpha(0.9),
                speed: 2.0,  // 更快速度
                repeat: 15.0,  // 更多箭头
                tailLength: 0.2
            },
            source: `
            uniform vec4 color;
            uniform float speed;
            uniform float repeat;
            uniform float tailLength;

            czm_material czm_getMaterial(czm_materialInput materialInput)
            {
                czm_material material = czm_getDefaultMaterial(materialInput);
                float time = czm_frameNumber * speed / 1000.0;
                float v = fract(materialInput.s * repeat - time);

                // 改进的箭头形状
                float arrow = smoothstep(0.0, 0.1, v) *
                            (1.0 - smoothstep(tailLength, tailLength + 0.1, v));

                // 增加边缘锐利度
                arrow = pow(arrow, 0.3);

                material.diffuse = color.rgb;
                material.alpha = arrow * color.a;
                material.emission = material.diffuse * 0.7;

                return material;
            }
        `
        }
    });
    console.log('flowingArrowMaterial',flowingArrowMaterial)

    // 更明显的箭头线
    var arrowLine = viewer.entities.add({
        polyline: {
            positions: positions,
            width: 6,
            material: new Cesium.Material({
                fabric: {
                    type: 'FlowArrow',
                    uniforms: {
                        color: Cesium.Color.RED.withAlpha(0.9),
                        speed: 2.0,  // 更快速度
                        repeat: 15.0,  // 更多箭头
                        tailLength: 0.2
                    },
                    source: `
            uniform vec4 color;
            uniform float speed;
            uniform float repeat;
            uniform float tailLength;

            czm_material czm_getMaterial(czm_materialInput materialInput)
            {
                czm_material material = czm_getDefaultMaterial(materialInput);
                float time = czm_frameNumber * speed / 1000.0;
                float v = fract(materialInput.s * repeat - time);

                // 改进的箭头形状
                float arrow = smoothstep(0.0, 0.1, v) *
                            (1.0 - smoothstep(tailLength, tailLength + 0.1, v));

                // 增加边缘锐利度
                arrow = pow(arrow, 0.3);

                material.diffuse = color.rgb;
                material.alpha = arrow * color.a;
                material.emission = material.diffuse * 0.7;

                return material;
            }
        `
                }
            }),
            zIndex: 1

        }
    });
    setTimeout(()=>{
        const currentTime = Cesium.JulianDate.now();
        const material = arrowLine.polyline.getMeterial()
        console.log("Material:", material); // 应该能正确输出
    },5000)

    // 确保视角合适
    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(-96.0, 38.5, 2000000)
    });

</script>
</body>

</html>